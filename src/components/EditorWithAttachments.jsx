import React, { useEffect, useState, useRef } from 'react';
import { marked } from 'marked';
import TagInput from './TagInput';
export default function Editor({ note, onChange, onDelete, onTogglePin, uploadAttachment, removeAttachment }){ const [draft,setDraft]=useState(note||{title:'',body:'',tags:[],attachments:[]}); const [status,setStatus]=useState('idle'); const saveTimer=useRef(null); useEffect(()=>setDraft(note||{title:'',body:'',tags:[],attachments:[]}), [note]); useEffect(()=>{ if(!note) return; if(saveTimer.current) clearTimeout(saveTimer.current); saveTimer.current = setTimeout(async ()=>{ if(note.title !== draft.title || note.body !== draft.body || JSON.stringify(note.tags||[]) !== JSON.stringify(draft.tags||[])){ try{ setStatus('saving'); await onChange(note.id, { title: draft.title, body: draft.body, tags: draft.tags }); setStatus('saved'); setTimeout(()=>setStatus('idle'), 1000) }catch(e){ console.error(e); setStatus('nosave') } } else setStatus('idle') }, 700); return ()=> clearTimeout(saveTimer.current) }, [draft, note, onChange]); const onFile= async (e)=>{ const f = e.target.files?.[0]; if(!f) return; try{ const meta = await uploadAttachment(note.id, f); setDraft(s=>({...s, body: s.body + `\n![](${meta.url})\n`, attachments: [...(s.attachments||[]), meta]})) }catch(e){ alert('업로드 실패: ' + e.message) } }; if(!note) return <div className='flex-1 p-6'>노트를 선택하거나 새 노트를 만들어주세요.</div>; return (<div className='flex-1 p-4 flex flex-col'><div className='flex items-center justify-between mb-3 gap-4'><input className='text-2xl font-semibold p-2 border rounded w-full' value={draft.title} onChange={e=>setDraft(s=>({...s, title:e.target.value}))} placeholder='제목' /><div className='flex flex-col items-end gap-2'><div className='text-xs text-gray-500'>{status==='saving'?'저장 중…': status==='saved'?'저장됨':''}</div><div className='flex gap-2'><input id='file-input' type='file' onChange={onFile} /><button className='text-sm px-2 py-1 border rounded' onClick={()=>onTogglePin(note.id)}>{note.pinned? 'Unpin' : 'Pin'}</button><button className='text-sm text-red-600' onClick={()=>onDelete(note.id)}>삭제</button></div></div></div><div className='mb-3'><TagInput tags={draft.tags||[]} onChange={newTags=>setDraft(s=>({...s, tags:newTags}))} /></div><div className='flex-1 grid grid-cols-2 gap-4'><textarea value={draft.body} onChange={e=>setDraft(s=>({...s, body:e.target.value}))} className='w-full h-full p-3 border rounded resize-none' /><div className='prose overflow-auto p-3 border rounded'><div dangerouslySetInnerHTML={{ __html: marked.parse(draft.body || '') }} />{ (draft.attachments || []).length > 0 && (<div className='mt-3'><h4 className='font-semibold'>Attachments</h4><ul className='space-y-2 text-sm'>{draft.attachments.map(a=> (<li key={a.path} className='flex items-center justify-between gap-2'><a href={a.url} target='_blank' rel='noreferrer' className='underline'>{a.name}</a><button className='text-xs text-red-500' onClick={()=>{ removeAttachment(note.id, a) }}>삭제</button></li>))}</ul></div>)} </div></div></div>); }
